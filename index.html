<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Home Hub</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:      #0d1117;
    --surface: #161b22;
    --surface2:#1e2530;
    --border:  #2a3240;
    --amber:   #f5a623;
    --amber2:  #ffcb6b;
    --teal:    #4ecdc4;
    --rose:    #ff6b6b;
    --text:    #e8eaf0;
    --muted:   #7b8794;
    --success: #52d68a;
    --blue:    #5eb5f7;
  }
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    height: 100vh;
    overflow: hidden;
    background-image:
      radial-gradient(ellipse 80% 60% at 10% 0%,   rgba(245,166,35,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 90% 100%,  rgba(78,205,196,0.05) 0%, transparent 60%);
  }

  .dashboard {
    display: grid;
    grid-template-columns: 320px 1fr 300px;
    grid-template-rows: 72px 1fr 1fr;
    gap: 14px;
    padding: 16px;
    height: 100vh;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 4px;
  }

  .header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.9rem;
    color: var(--text);
  }
  .header h1 span { color: var(--amber); }
  .greeting { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

  #clock {
    font-family: 'DM Mono', monospace;
    font-size: 2.6rem;
    color: var(--amber);
    letter-spacing: 2px;
    line-height: 1;
    text-align: right;
  }
  #date-display { font-size: 0.75rem; color: var(--muted); text-align: right; margin-top: 3px; }

  /* â”€â”€ CARDS â”€â”€ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow: hidden;
    position: relative;
    animation: fadeUp 0.5s ease both;
  }
  .card::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:2px;
    background: linear-gradient(90deg,transparent,var(--accent,var(--amber)),transparent);
    opacity:0.6;
  }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(14px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .card-title {
    font-size: 0.62rem;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .dot {
    width:6px; height:6px; border-radius:50%;
    background: var(--accent, var(--amber));
    box-shadow: 0 0 6px var(--accent, var(--amber));
  }

  /* â”€â”€ WEATHER â”€â”€ */
  .weather-card { --accent: var(--teal); animation-delay:0.05s; }
  .weather-main { display:flex; align-items:flex-end; gap:12px; }
  .weather-icon { font-size:3rem; line-height:1; }
  .weather-temp { font-family:'DM Serif Display',serif; font-size:2.6rem; color:var(--teal); line-height:1; }
  .weather-meta { font-size:0.72rem; color:var(--muted); line-height:1.8; }
  .weather-meta strong { color:var(--text); }
  .weather-tags { display:flex; gap:8px; flex-wrap:wrap; }
  .wtag {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:7px; padding:4px 9px; font-size:0.68rem; color:var(--muted);
  }
  .wtag span { color:var(--teal); font-weight:600; }

  /* â”€â”€ CALENDAR â”€â”€ */
  .calendar-card { --accent:var(--amber); grid-row: span 2; animation-delay:0.1s; }
  .event-list { display:flex; flex-direction:column; gap:7px; flex:1; overflow-y:auto; }
  .event-list::-webkit-scrollbar { width:3px; }
  .event-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

  .event-item {
    background:var(--surface2); border:1px solid var(--border);
    border-left:3px solid var(--amber); border-radius:9px; padding:10px 12px;
  }
  .event-item.today  { border-left-color:var(--rose); }
  .event-time { font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--muted); margin-bottom:3px; }
  .event-name { font-size:0.82rem; font-weight:500; }
  .event-badge {
    display:inline-block; font-size:0.58rem; font-weight:600;
    letter-spacing:1px; text-transform:uppercase; padding:2px 6px; border-radius:4px; margin-top:4px;
  }
  .badge-today    { background:rgba(255,107,107,0.15); color:var(--rose); }
  .badge-tomorrow { background:rgba(245,166,35,0.15);  color:var(--amber); }

  /* â”€â”€ TELEGRAM â”€â”€ */
  .telegram-card { --accent:var(--blue); animation-delay:0.15s; }
  .messages-list { display:flex; flex-direction:column; gap:7px; flex:1; overflow-y:auto; max-height:140px; }
  .messages-list::-webkit-scrollbar { width:3px; }
  .messages-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

  .msg-bubble {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:9px; padding:8px 11px; animation:fadeUp 0.3s ease;
  }
  .msg-header { display:flex; justify-content:space-between; margin-bottom:3px; }
  .msg-sender { font-size:0.68rem; font-weight:600; color:var(--blue); }
  .msg-time   { font-size:0.62rem; color:var(--muted); font-family:'DM Mono',monospace; }
  .msg-text   { font-size:0.8rem; color:var(--text); line-height:1.4; }

  .tg-row { display:flex; gap:7px; }
  .tg-input {
    flex:1; background:var(--surface2); border:1px solid var(--border);
    border-radius:7px; padding:7px 10px; color:var(--text);
    font-family:'DM Sans',sans-serif; font-size:0.78rem; outline:none;
    transition:border-color 0.2s;
  }
  .tg-input:focus { border-color:var(--blue); }
  .tg-input::placeholder { color:var(--muted); }

  .send-btn {
    background:var(--blue); color:#0d1117; border:none; border-radius:7px;
    padding:7px 13px; font-weight:600; font-size:0.75rem; cursor:pointer;
    transition:background 0.2s;
  }
  .send-btn:hover { background:#7dc5ff; }

  /* â”€â”€ TODO â”€â”€ */
  .todo-card { --accent:var(--success); animation-delay:0.2s; }
  .todo-list { display:flex; flex-direction:column; gap:5px; flex:1; overflow-y:auto; }
  .todo-list::-webkit-scrollbar { width:3px; }
  .todo-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

  .todo-item {
    display:flex; align-items:center; gap:9px; padding:7px 9px;
    background:var(--surface2); border:1px solid var(--border); border-radius:7px;
    transition:opacity 0.2s;
  }
  .todo-item.done { opacity:0.4; }
  .todo-check {
    width:16px; height:16px; border:2px solid var(--border); border-radius:4px;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink:0; font-size:0.6rem; transition:background 0.2s, border-color 0.2s;
  }
  .todo-item.done .todo-check { background:var(--success); border-color:var(--success); color:#0d1117; }
  .todo-text { font-size:0.8rem; color:var(--text); flex:1; }
  .todo-item.done .todo-text { text-decoration:line-through; color:var(--muted); }
  .todo-who {
    font-size:0.62rem; color:var(--muted); background:var(--surface);
    padding:2px 6px; border-radius:4px; border:1px solid var(--border);
  }

  .add-row { display:flex; gap:7px; }
  .add-input {
    flex:1; background:var(--surface2); border:1px solid var(--border);
    border-radius:7px; padding:6px 9px; color:var(--text);
    font-family:'DM Sans',sans-serif; font-size:0.75rem; outline:none;
    transition:border-color 0.2s;
  }
  .add-input:focus { border-color:var(--success); }
  .add-input::placeholder { color:var(--muted); }
  .add-btn {
    background:var(--success); color:#0d1117; border:none;
    border-radius:7px; padding:6px 12px; font-weight:700; font-size:1rem; cursor:pointer;
  }
  .add-btn:hover { background:#6ee8a4; }

  /* â”€â”€ NOTICEBOARD â”€â”€ */
  .notice-card { --accent:var(--rose); grid-column:2/3; animation-delay:0.25s; }
  .notice-list { display:flex; flex-direction:column; gap:7px; flex:1; overflow-y:auto; }
  .notice-list::-webkit-scrollbar { width:3px; }
  .notice-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

  .notice-post {
    background:var(--surface2); border:1px solid var(--border);
    border-left:3px solid var(--rose); border-radius:9px; padding:10px 12px;
    display:flex; justify-content:space-between; align-items:flex-start;
  }
  .notice-text   { font-size:0.82rem; color:var(--text); line-height:1.5; }
  .notice-author { font-size:0.62rem; color:var(--muted); margin-top:3px; }
  .notice-del {
    background:none; border:none; color:var(--muted); cursor:pointer;
    font-size:0.85rem; padding-left:8px; transition:color 0.2s;
  }
  .notice-del:hover { color:var(--rose); }

  /* â”€â”€ AGENT CHAT â”€â”€ */
  .agent-card { --accent:var(--purple,#b060ff); animation-delay:0.3s; --accent:#b060ff; }

  .agent-response {
    background: linear-gradient(135deg, rgba(176,96,255,0.08), rgba(0,212,255,0.05));
    border: 1px solid rgba(176,96,255,0.2);
    border-radius: 9px;
    padding: 10px 12px;
    font-size: 0.78rem;
    color: var(--text);
    line-height: 1.6;
    min-height: 50px;
    flex: 1;
    overflow-y: auto;
  }

  .agent-response.thinking {
    color: var(--muted);
    font-style: italic;
  }

  .agent-input-row { display:flex; gap:7px; }
  .agent-input {
    flex:1; background:var(--surface2); border:1px solid var(--border);
    border-radius:7px; padding:7px 10px; color:var(--text);
    font-family:'DM Sans',sans-serif; font-size:0.78rem; outline:none;
    transition:border-color 0.2s;
  }
  .agent-input:focus { border-color:#b060ff; }
  .agent-input::placeholder { color:var(--muted); }

  .agent-btn {
    background:#b060ff; color:#fff; border:none; border-radius:7px;
    padding:7px 13px; font-weight:600; font-size:0.75rem; cursor:pointer;
    transition:background 0.2s;
  }
  .agent-btn:hover { background:#c880ff; }
  .agent-btn:disabled { opacity:0.5; cursor:not-allowed; }

  .agent-examples {
    display:flex; flex-wrap:wrap; gap:5px;
  }

  .example-chip {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:20px; padding:3px 10px; font-size:0.65rem; color:var(--muted);
    cursor:pointer; transition:border-color 0.2s, color 0.2s;
  }
  .example-chip:hover { border-color:#b060ff; color:#b060ff; }

  /* â”€â”€ LIVE DOT â”€â”€ */
  .live { display:inline-flex; align-items:center; gap:5px; font-size:0.62rem; color:var(--success); }
  .live::before {
    content:''; width:6px; height:6px; background:var(--success);
    border-radius:50%; animation:pulse 2s infinite;
  }
  @keyframes pulse {
    0%,100% { box-shadow:0 0 0 0 rgba(82,214,138,0.4); }
    50%      { box-shadow:0 0 0 5px rgba(82,214,138,0); }
  }

  .no-items { color:var(--muted); font-size:0.75rem; text-align:center; padding:12px 0; }

  .spinner {
    display:inline-block; width:10px; height:10px;
    border:2px solid rgba(176,96,255,0.3); border-top-color:#b060ff;
    border-radius:50%; animation:spin 0.7s linear infinite; margin-right:6px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>
<div class="dashboard">

  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Home <span>Hub</span></h1>
      <div class="greeting" id="greeting">Good morning, Family!</div>
    </div>
    <div style="display:flex;align-items:center;gap:18px;">
      <span class="live" id="status-dot">LIVE</span>
      <div>
        <div id="clock">00:00:00</div>
        <div id="date-display">â€”</div>
      </div>
    </div>
  </header>

  <!-- WEATHER -->
  <div class="card weather-card">
    <div class="card-title"><span class="dot"></span>Weather</div>
    <div class="weather-main">
      <div class="weather-icon" id="w-icon">â›…</div>
      <div>
        <div class="weather-temp" id="w-temp">â€”Â°C</div>
        <div class="weather-meta" id="w-desc">Loadingâ€¦</div>
      </div>
    </div>
    <div class="weather-tags">
      <div class="wtag">Humidity <span id="w-hum">â€”</span></div>
      <div class="wtag">Wind <span id="w-wind">â€”</span></div>
      <div class="wtag">Feels <span id="w-feels">â€”</span></div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div class="card calendar-card">
    <div class="card-title"><span class="dot"></span>Upcoming Events â€” Next 2 Days</div>
    <div class="event-list" id="event-list"><div class="no-items">Loading eventsâ€¦</div></div>
  </div>

  <!-- TELEGRAM -->
  <div class="card telegram-card">
    <div class="card-title"><span class="dot"></span>Telegram â€” Family Messages</div>
    <div class="messages-list" id="messages-list">
      <div class="no-items">Loading messagesâ€¦</div>
    </div>
    <div class="tg-row">
      <input class="tg-input" id="tg-input" type="text" placeholder="Message the familyâ€¦"/>
      <button class="send-btn" onclick="sendTelegram()">Send</button>
    </div>
  </div>

  <!-- TODO -->
  <div class="card todo-card">
    <div class="card-title"><span class="dot"></span>Family Chores & To-Do</div>
    <div class="todo-list" id="todo-list"><div class="no-items">Loadingâ€¦</div></div>
    <div class="add-row">
      <input class="add-input" id="todo-input" type="text" placeholder="Add task â€“ Who (e.g. Clean room â€“ Kids)"/>
      <button class="add-btn" onclick="addTodo()">+</button>
    </div>
  </div>

  <!-- NOTICEBOARD -->
  <div class="card notice-card">
    <div class="card-title"><span class="dot"></span>Family Noticeboard</div>
    <div class="notice-list" id="notice-list"><div class="no-items">Loadingâ€¦</div></div>
    <div class="add-row">
      <input class="add-input" id="notice-input" style="--focus:var(--rose)" type="text" placeholder="Post a notice or reminderâ€¦"/>
      <button class="add-btn" style="background:var(--rose);color:#fff" onclick="addNotice()">+</button>
    </div>
  </div>

  <!-- AI AGENT CHAT -->
  <div class="card agent-card">
    <div class="card-title"><span class="dot" style="background:#b060ff;box-shadow:0 0 6px #b060ff"></span>AI Agent â€” Ask or Command</div>
    <div class="agent-response thinking" id="agent-response">
      Ask me anythingâ€¦ e.g. "What's on today?" or "Remind kids about homework"
    </div>
    <div class="agent-examples" id="agent-examples">
      <span class="example-chip" onclick="askAgent(this.textContent)">What's on today?</span>
      <span class="example-chip" onclick="askAgent(this.textContent)">How's the weather?</span>
      <span class="example-chip" onclick="askAgent(this.textContent)">Add groceries to chores</span>
      <span class="example-chip" onclick="askAgent(this.textContent)">Message kids: dinner at 7</span>
      <span class="example-chip" onclick="askAgent(this.textContent)">Post a motivational quote</span>
    </div>
    <div class="agent-input-row">
      <input class="agent-input" id="agent-input" type="text" placeholder="Type a command or questionâ€¦"/>
      <button class="agent-btn" id="agent-btn" onclick="sendAgent()">Ask âœ¦</button>
    </div>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš™ï¸  CONFIG â€” Update AGENT_URL after deploying to Render
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AGENT_URL = "https://homehub-agent.onrender.com"; // â† Replace after Render deploy
let agentHistory = [];

// â”€â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  document.getElementById('clock').textContent =
    `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

  const days   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('date-display').textContent =
    `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;

  const hr = now.getHours();
  const g  = hr < 12 ? 'Good morning' : hr < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('greeting').textContent = `${g}, Family!`;
}
setInterval(updateClock, 1000);
updateClock();


// â”€â”€â”€ LOAD ALL DATA FROM AGENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  try {
    const res  = await fetch(`${AGENT_URL}/data/all`);
    const data = await res.json();

    renderWeather(data.weather);
    renderEvents(data.events);
    renderMessages(data.messages);
    renderTodos(data.todos?.todos || []);
    renderNotices(data.notices || []);

    document.getElementById('status-dot').textContent = 'LIVE';
    document.getElementById('status-dot').style.color = 'var(--success)';
  } catch(e) {
    console.error('Data load error:', e);
    document.getElementById('status-dot').textContent = 'OFFLINE';
    document.getElementById('status-dot').style.color = 'var(--rose)';
  }
}


// â”€â”€â”€ WEATHER RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeather(w) {
  if (!w || w.error) return;
  const icons = {
    'Clear sky':'â˜€ï¸','Mainly clear':'ðŸŒ¤ï¸','Partly cloudy':'â›…','Overcast':'â˜ï¸',
    'Fog':'ðŸŒ«ï¸','Light drizzle':'ðŸŒ¦ï¸','Drizzle':'ðŸŒ¦ï¸','Heavy drizzle':'ðŸŒ§ï¸',
    'Light rain':'ðŸŒ§ï¸','Rain':'ðŸŒ§ï¸','Heavy rain':'ðŸŒ§ï¸',
    'Rain showers':'ðŸŒ¦ï¸','Violent showers':'â›ˆï¸','Thunderstorm':'â›ˆï¸',
    'Light snow':'â„ï¸','Snow':'â„ï¸','Heavy snow':'â„ï¸',
  };
  document.getElementById('w-icon').textContent = icons[w.condition] || 'ðŸŒ¡ï¸';
  document.getElementById('w-temp').textContent = `${w.temperature_c}Â°C`;
  document.getElementById('w-desc').innerHTML   = `<strong>${w.city}</strong><br/>${w.condition}`;
  document.getElementById('w-hum').textContent  = `${w.humidity_pct}%`;
  document.getElementById('w-wind').textContent = `${w.wind_kmh} km/h`;
  document.getElementById('w-feels').textContent= `${w.feels_like_c}Â°C`;
}


// â”€â”€â”€ CALENDAR RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEvents(events) {
  const el = document.getElementById('event-list');
  if (!events || events.length === 0 || events[0]?.message) {
    el.innerHTML = `<div class="no-items">${events?.[0]?.message || 'No upcoming events ðŸŽ‰'}</div>`;
    return;
  }
  el.innerHTML = '';
  events.forEach(ev => {
    const dt      = new Date(ev.start);
    const isToday = dt.getDate() === new Date().getDate();
    const timeStr = ev.all_day ? 'All day' : dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const div = document.createElement('div');
    div.className = `event-item ${isToday ? 'today' : ''}`;
    div.innerHTML = `
      <div class="event-time">${isToday ? 'TODAY' : 'TOMORROW'} Â· ${timeStr}</div>
      <div class="event-name">${ev.title}</div>
      <span class="event-badge ${isToday ? 'badge-today' : 'badge-tomorrow'}">${isToday ? 'Today' : 'Tomorrow'}</span>
    `;
    el.appendChild(div);
  });
}


// â”€â”€â”€ MESSAGES RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMessages(messages) {
  const el = document.getElementById('messages-list');
  if (!messages || messages[0]?.message || messages[0]?.error) {
    el.innerHTML = `<div class="no-items">${messages?.[0]?.message || 'No recent messages'}</div>`;
    return;
  }
  el.innerHTML = '';
  messages.slice(-6).forEach(m => {
    const div = document.createElement('div');
    div.className = 'msg-bubble';
    div.innerHTML = `
      <div class="msg-header">
        <span class="msg-sender">${m.sender}</span>
        <span class="msg-time">${m.time}</span>
      </div>
      <div class="msg-text">${m.text}</div>
    `;
    el.appendChild(div);
  });
  el.scrollTop = el.scrollHeight;
}


// â”€â”€â”€ SEND TELEGRAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendTelegram() {
  const input = document.getElementById('tg-input');
  const text  = input.value.trim();
  if (!text) return;
  input.value = '';

  try {
    await fetch(`${AGENT_URL}/agent/chat`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        message: `Send this Telegram message to the family: "${text}"`,
        history: agentHistory
      })
    });
    // Optimistically add to UI
    const el  = document.getElementById('messages-list');
    const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const div = document.createElement('div');
    div.className = 'msg-bubble';
    div.innerHTML = `
      <div class="msg-header"><span class="msg-sender">You</span><span class="msg-time">${now}</span></div>
      <div class="msg-text">${text}</div>
    `;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
  } catch(e) { alert('Could not send message. Is the agent running?'); }
}


// â”€â”€â”€ TODO RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTodos(todos) {
  const el = document.getElementById('todo-list');
  if (!todos.length) { el.innerHTML = '<div class="no-items">No tasks yet â€” add one below!</div>'; return; }
  el.innerHTML = '';
  todos.forEach(t => {
    const div = document.createElement('div');
    div.className = `todo-item ${t.done ? 'done' : ''}`;
    div.innerHTML = `
      <div class="todo-check" onclick="completeTodo(${t.id})">${t.done ? 'âœ“' : ''}</div>
      <div class="todo-text">${t.text}</div>
      <div class="todo-who">${t.who}</div>
    `;
    el.appendChild(div);
  });
}

async function completeTodo(id) {
  await fetch(`${AGENT_URL}/agent/chat`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ message: `Mark todo task id ${id} as complete`, history: [] })
  });
  loadAllData();
}

async function addTodo() {
  const input = document.getElementById('todo-input');
  const val   = input.value.trim();
  if (!val) return;
  input.value = '';
  const parts = val.split('â€“').map(s => s.trim());
  await fetch(`${AGENT_URL}/agent/chat`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      message: `Add todo task: "${parts[0]}" assigned to ${parts[1] || 'Family'}`,
      history: []
    })
  });
  loadAllData();
}


// â”€â”€â”€ NOTICES RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNotices(notices) {
  const el = document.getElementById('notice-list');
  if (!notices.length) { el.innerHTML = '<div class="no-items">No notices yet.</div>'; return; }
  el.innerHTML = '';
  notices.forEach(n => {
    const div = document.createElement('div');
    div.className = 'notice-post';
    div.innerHTML = `
      <div>
        <div class="notice-text">${n.text}</div>
        <div class="notice-author">â€” ${n.author} Â· ${n.time || ''}</div>
      </div>
      <button class="notice-del" onclick="deleteNotice(${n.id})">âœ•</button>
    `;
    el.appendChild(div);
  });
}

async function deleteNotice(id) {
  await fetch(`${AGENT_URL}/agent/chat`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ message: `Delete notice id ${id}`, history: [] })
  });
  loadAllData();
}

async function addNotice() {
  const input = document.getElementById('notice-input');
  const val   = input.value.trim();
  if (!val) return;
  input.value = '';
  await fetch(`${AGENT_URL}/agent/chat`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ message: `Post this on the noticeboard: "${val}"`, history: [] })
  });
  loadAllData();
}


// â”€â”€â”€ AI AGENT CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAgent() {
  const input = document.getElementById('agent-input');
  const text  = input.value.trim();
  if (!text) return;
  await askAgent(text);
  input.value = '';
}

async function askAgent(text) {
  const responseEl = document.getElementById('agent-response');
  const btn        = document.getElementById('agent-btn');

  responseEl.className = 'agent-response thinking';
  responseEl.innerHTML = '<span class="spinner"></span>Thinkingâ€¦';
  btn.disabled = true;

  try {
    const res  = await fetch(`${AGENT_URL}/agent/chat`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: text, history: agentHistory })
    });
    const data = await res.json();
    agentHistory = data.history;

    responseEl.className = 'agent-response';
    responseEl.textContent = data.reply || 'Done!';

    // Refresh relevant data after agent action
    setTimeout(loadAllData, 800);
  } catch(e) {
    responseEl.className = 'agent-response thinking';
    responseEl.textContent = 'âš ï¸ Could not reach agent. Is it deployed on Render?';
  } finally {
    btn.disabled = false;
  }
}

document.getElementById('agent-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendAgent();
});
document.getElementById('tg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendTelegram();
});
document.getElementById('todo-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') addTodo();
});
document.getElementById('notice-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') addNotice();
});


// â”€â”€â”€ KEEP RENDER ALIVE (ping every 10 min) â”€â”€
async function pingAgent() {
  try { await fetch(`${AGENT_URL}/ping`); } catch(e) {}
}


// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadAllData();
pingAgent();
setInterval(loadAllData,  5 * 60 * 1000);   // refresh data every 5 min
setInterval(pingAgent,   10 * 60 * 1000);   // keep Render alive every 10 min
</script>
</body>
</html>
